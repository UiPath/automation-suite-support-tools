"use strict";(self.webpackChunkdocs_website=self.webpackChunkdocs_website||[]).push([[2355],{739:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>c,frontMatter:()=>s,metadata:()=>l,toc:()=>d});var i=t(5893),o=t(1151);const s={sidebar_position:1},r="Longhorn CSI Plugin Fails to Start",l={id:"networking/longhorn-csi-plugin-fails-to-start",title:"Longhorn CSI Plugin Fails to Start",description:"This is not official documentation for AutomationSuite",source:"@site/docs/networking/longhorn-csi-plugin-fails-to-start.md",sourceDirName:"networking",slug:"/networking/longhorn-csi-plugin-fails-to-start",permalink:"/automation-suite-support-tools/docs/networking/longhorn-csi-plugin-fails-to-start",draft:!1,unlisted:!1,editUrl:"https://uipath.github.com/UiPath/automation-suite-support-tools/edit/master/docs/docs/networking/longhorn-csi-plugin-fails-to-start.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Networking Troubleshooting",permalink:"/automation-suite-support-tools/docs/category/networking-troubleshooting"},next:{title:"Longhorn Troubleshooting",permalink:"/automation-suite-support-tools/docs/category/longhorn-troubleshooting"}},a={},d=[{value:"Issue Description",id:"issue-description",level:2},{value:"Root Cause",id:"root-cause",level:2},{value:"Diagnosis",id:"diagnosis",level:2},{value:"Debugging Node Overlay Network Issue",id:"debugging-node-overlay-network-issue",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"longhorn-csi-plugin-fails-to-start",children:"Longhorn CSI Plugin Fails to Start"}),"\n",(0,i.jsx)(n.admonition,{title:"Note",type:"danger",children:(0,i.jsx)(n.p,{children:"This is not official documentation for AutomationSuite"})}),"\n",(0,i.jsx)(n.h2,{id:"issue-description",children:"Issue Description"}),"\n",(0,i.jsx)(n.p,{children:"During the installation of Automation Suite or AI Center via Automation Suite, the longhorn-csi-plugin fails to start."}),"\n",(0,i.jsx)(n.h2,{id:"root-cause",children:"Root Cause"}),"\n",(0,i.jsx)(n.p,{children:"The longhorn CSI plugin is the interface between Kubernetes (the container Orchestration platform used in Automation Suite) and longhorn (the storage solution used for persistent data)."}),"\n",(0,i.jsx)(n.p,{children:"In other words it allows the Kubernetes engine to talk to the storage engine.  If the CSI plugin is not starting, it can be cause by many issues but is usually symptomatic of a more fundamental problem."}),"\n",(0,i.jsx)(n.h2,{id:"diagnosis",children:"Diagnosis"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"If the longhorn-csi-plugin pod is not starting, it is probably in a CrashLoopBackOff state. The first thing to do to is list to get more info about the state."}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Run this command ",(0,i.jsx)(n.code,{children:"kubectl -n longhorn-system get pods -l app=longhorn-csi-plugin -o wide"})]}),"\n",(0,i.jsxs)(n.li,{children:["In the output pay attention to the ",(0,i.jsx)(n.code,{children:"READY"})," column. If the ",(0,i.jsx)(n.code,{children:"READY"})," column is ",(0,i.jsx)(n.code,{children:"1/2"}),", it most likely means that the CSI-Plugin cannot talk to longhorn backend. This will be covered in later steps.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Example:  ",(0,i.jsx)(n.code,{children:"longhorn-system   longhorn-csi-plugin-jwvnj  1/2     CrashLoopBackOff"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Also pay attention to which node the failed pod is running on."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Next, do a describe of the pod to make sure that any other important information is identified"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["This returns a list of the pods that are running in the cluster. Look for the one that is in a crashed state ",(0,i.jsx)(n.code,{children:"kubectl -n longhorn-system get pods -l app=longhorn-csi-plugin"})]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"kubectl -n describe pod <pod name>"})}),"\n",(0,i.jsxs)(n.li,{children:["Alternatively run the command:  ",(0,i.jsx)(n.code,{children:"kubectl -n longhorn-system describe pod -l app=longhorn-csi-plugin"})]}),"\n",(0,i.jsx)(n.li,{children:"Look at the events associated with the Pod. They are at the end of the output and usually they include some helpful information."}),"\n",(0,i.jsxs)(n.li,{children:["Most likely the error will be: ",(0,i.jsx)(n.code,{children:"Back-off restarting failed container"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Try to get the logs from the crashed instance"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["identity the pod that is in a crashed state ",(0,i.jsx)(n.code,{children:"kubectl -n longhorn-system get pods -l app=longhorn-csi-plugin"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"kubectl -n longhorn-system logs <pod name> -c longhorn-csi-plugin"})," (Note, the -p option might need to be added at the end of the command.)","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Check for the error: ",(0,i.jsx)(n.code,{children:'Failed to initialize Longhorn API client: Get \\"http://longhorn-backend:9500/v1\\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"'})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Get the logs for the node-driver-registrar","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"kubectl -n longhorn-system logs <pod name> node-driver-registrar"})," (Note, the -p option might need to be added at the end of the command.)\nCheck for the error: ",(0,i.jsx)(n.code,{children:"W0423 04:16:48.096462   11095 connection.go:173] Still connecting to unix:///csi/csi.sock"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"If the two errors mentioned above are seen, the issue is most likely that the different nodes in the network cannot talk to each other and something is wrong with the overlay network. Go to the Section Debugging Node Overlay Network"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["If the the logs did not show the errors mentioned, or if the issue is still not clear, create a support bundle using the ",(0,i.jsx)(n.a,{href:"https://www.suse.com/support/kb/doc/?id=000020191",children:"Linux Log Collector Script"})," and send the information to UiPath ."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"debugging-node-overlay-network-issue",children:"Debugging Node Overlay Network Issue"}),"\n",(0,i.jsx)(n.admonition,{title:"Note",type:"tip",children:(0,i.jsx)(n.p,{children:"These steps only apply to Multi-node installations."})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["First, go through the following KB article to see if the overlay network is functioning ",(0,i.jsx)(n.a,{href:"https://ranchermanager.docs.rancher.com/v2.5/troubleshooting/other-troubleshooting-tips/networking#check-if-overlay-network-is-functioning-correctly.",children:"overlay networking test"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Hint: This can also be verified via step 6 below by using a TCP dump to check if UDP packets are reaching nodes"}),"\n",(0,i.jsx)(n.li,{children:"For airgapped environments, most likely the tcpdump test will be easier to perform"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"If the tests fail, that means the overlay network is not working"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If the test passes, then create a support bundle for UiPath Support and raise a ticket. ",(0,i.jsx)(n.a,{href:"https://www.suse.com/support/kb/doc/?id=000020191",children:"Following this procedure"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"If the test failed, then that means the overlay network is not working. Most likely the culprit is that the nodes cannot communicate over UDP port 8472"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["This port is mentioned in the ",(0,i.jsx)(n.a,{href:"https://docs.uipath.com/automation-suite/automation-suite/2023.10#enabling-ports",children:"documentation"})]}),"\n",(0,i.jsxs)(n.li,{children:["Typically there are three culprits that can cause this","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Local Firewall"}),"\n",(0,i.jsx)(n.li,{children:"IPTables on the VM"}),"\n",(0,i.jsx)(n.li,{children:"Network firewall that exists outside of the VM"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["The default redhat firewall is firewall. The state can be checked with the command,","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"firewall-cmd --state"})}),"\n",(0,i.jsxs)(n.li,{children:["To open the port,","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"sudo firewall-cmd --zone=public --permanent --add-port=8472/udp"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"sudo firewall-cmd --reload"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{title:"Important:",type:"danger",children:(0,i.jsx)(n.p,{children:"It is best to talk to the Linux Administrator and Security teams before making changes like this. Additionally, they may be using a different firewall solution or they may have a private zone."})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Finally, it might be best to see if the firewall can be turned off. It is often easier to manage and some Linux administrators prefer to keep it simple by having a firewall at the network level in a place that exists outside of the VM."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"If the firewall is disabled then the next culprit could be IP Tables"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["IP Tables can be complicated to troubleshoot. However, if logging is enabled for the IP Tables, then a check can be done to see if packages are being dropped.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Note IP Tables can be easier to read by using the ",(0,i.jsx)(n.code,{children:"-S"})," command. For example to see the rules for the input table try: ",(0,i.jsx)(n.code,{children:"iptables -S INPUT"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Make sure to be on the node where the pod is crashed. This information was gathered in Step 1. of the Diagnosing Section"}),"\n",(0,i.jsxs)(n.li,{children:["Run the command:  ",(0,i.jsx)(n.code,{children:"iptables -A INPUT -j LOG --log-prefix DROPPED_INPUT"})]}),"\n",(0,i.jsxs)(n.li,{children:["This will cause dropped packages to be logged in ",(0,i.jsx)(n.code,{children:"/var/log/messages"})]}),"\n",(0,i.jsxs)(n.li,{children:["Run the following command to see if packets are being dropped: ",(0,i.jsx)(n.code,{children:'tail -f /var/log/messages | grep "DROPPED_INPUT.*DPT=8472"'})]}),"\n",(0,i.jsx)(n.li,{children:"If the command returns anything packages are being dropped."}),"\n",(0,i.jsx)(n.li,{children:"Talk to your Admin who setup the IP tables to get the ports unblocked or an exception added to the IP Tables"}),"\n",(0,i.jsx)(n.li,{children:"Also note that some Linux administrator recommend not configuring IP Tables on specific machines and instead relying on your network firewall"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"To determine if the issue is caused by an external firewall, perform a package capture,"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["To do a package capture, tcpdump must be installed: ",(0,i.jsx)(n.code,{children:"yum install tcpdump"})]}),"\n",(0,i.jsxs)(n.li,{children:["To see if traffic is coming through run: ",(0,i.jsx)(n.code,{children:"tcpdump -i any udp and port 8472"})]}),"\n",(0,i.jsx)(n.li,{children:"Let the command run for a few minutes. If not traffic is coming through most likely its being blocked by an external firewall."}),"\n",(0,i.jsx)(n.li,{children:"Its also possibly the issue is intermittent if there is an external dynamic firewall."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Another quick test is to test UDP on a different port"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["On the node where the pod is crashing, run: ",(0,i.jsx)(n.code,{children:"nc -ul <random port number>"})," - This creates a UDP listener"]}),"\n",(0,i.jsxs)(n.li,{children:["On another node, run: ",(0,i.jsx)(n.code,{children:"nc -u <first node name> <port number from previous step>"})]}),"\n",(0,i.jsx)(n.li,{children:"Then, on the second node, type something and hit enter. The typed text should show up on the first node where the UDP listener is running"}),"\n",(0,i.jsx)(n.li,{children:"If this test does not work, then that means either UDP is only allowed on some ports, or UDP is indeed blocked."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["If the above steps do not help, use the following link to create a ",(0,i.jsx)(n.a,{href:"https://www.suse.com/support/kb/doc/?id=000020191",children:"support bundle"})," to send to UiPath"]}),"\n"]}),"\n"]})]})}function c(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>l,a:()=>r});var i=t(7294);const o={},s=i.createContext(o);function r(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);