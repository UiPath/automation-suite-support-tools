"use strict";(self.webpackChunkdocs_website=self.webpackChunkdocs_website||[]).push([[6841],{8569:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>i,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var t=n(5893),s=n(1151);const a={sidebar_position:1},r="Backup failed because of TooManySnapshot error",l={id:"backup/troubleshooting-too-many-snapshots",title:"Backup failed because of TooManySnapshot error",description:"This is not official documentation for AutomationSuite",source:"@site/docs/backup/troubleshooting-too-many-snapshots.md",sourceDirName:"backup",slug:"/backup/troubleshooting-too-many-snapshots",permalink:"/automation-suite-support-tools/docs/backup/troubleshooting-too-many-snapshots",draft:!1,unlisted:!1,editUrl:"https://uipath.github.com/UiPath/automation-suite-support-tools/edit/master/docs/docs/backup/troubleshooting-too-many-snapshots.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"DR Troubleshooting",permalink:"/automation-suite-support-tools/docs/category/dr-troubleshooting"},next:{title:"Upgrade Troubleshooting",permalink:"/automation-suite-support-tools/docs/category/upgrade-troubleshooting"}},i={},c=[{value:"How to automate snapshot cleanup",id:"how-to-automate-snapshot-cleanup",level:3}];function p(e){const o={a:"a",admonition:"admonition",code:"code",h1:"h1",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o.h1,{id:"backup-failed-because-of-toomanysnapshot-error",children:"Backup failed because of TooManySnapshot error"}),"\n",(0,t.jsx)(o.admonition,{title:"Note",type:"danger",children:(0,t.jsx)(o.p,{children:"This is not official documentation for AutomationSuite"})}),"\n",(0,t.jsxs)(o.p,{children:["During backup, longhorn volumes are backup by taking the snapshot of volume and sending the snapshot to remote location. If longhorn volume is having issue with snapshot creation, i.e if snapshot count for volume reached to ",(0,t.jsx)(o.code,{children:">248"}),", then backup will not succeed (since snapshot creation will fail)."]}),"\n",(0,t.jsxs)(o.p,{children:["There are multiple steps to identify if backup is failing because of ",(0,t.jsx)(o.code,{children:"TooManySnapshot"})," error:"]}),"\n",(0,t.jsxs)(o.ol,{children:["\n",(0,t.jsx)(o.li,{children:"By checking velero logs using below command:"}),"\n"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:' kubectl logs  -n velero -l app.kubernetes.io/name=velero -c velero |grep "Waiting for volumesnapshotcontents"\n'})}),"\n",(0,t.jsx)(o.p,{children:"Sample output:"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:'time="2023-12-15T08:15:59Z" level=info msg="Waiting for volumesnapshotcontents snapcontent-f073b88e-bd01-40a8-a645-ec929e276cef to have snapshot handle. Retrying in 5s" backup=velero/daily-2 cmd=/plugins/velero-plugin-for-csi logSource="/go/src/velero-plugin-for-csi/internal/util/util.go:182" pluginName=velero-plugin-for-csi\ntime="2023-12-15T08:15:59Z" level=info msg="Waiting for volumesnapshotcontents snapcontent-f073b88e-bd01-40a8-a645-ec929e276cef to have snapshot handle. Retrying in 5s" backup=velero/daily-2 cmd=/plugins/velero-plugin-for-csi logSource="/go/src/velero-plugin-for-csi/internal/util/util.go:182" pluginName=velero-plugin-for-csi\n'})}),"\n",(0,t.jsxs)(o.ol,{start:"2",children:["\n",(0,t.jsx)(o.li,{children:"By checking longhorn pods logs using below command:"}),"\n"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:'kubectl logs  -n longhorn-system -l app=csi-snapshotter --tail=-1 |grep "too many snapshots created"\n'})}),"\n",(0,t.jsx)(o.p,{children:"Sample Output:"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:"I1215 08:39:41.707351       1 snapshot_controller.go:291] createSnapshotWrapper: CreateSnapshot for content snapcontent-f073b88e-bd01-40a8-a645-ec929e276cef returned error: rpc error: code = Internal desc = Bad response statusCode [500]. Status [500 Internal Server Error]. Body: [code=Server Error, detail=, message=failed to create snapshot: proxyServer=10.42.7.56:8501 destination=10.42.7.56:10004: failed to snapshot volume: rpc error: code = Unknown desc = failed to create snapshot snapshot-f073b88e-bd01-40a8-a645-ec929e276cef for volume 10.42.7.56:10004: rpc error: code = Unknown desc = too many snapshots created] from [http://longhorn-backend:9500/v1/volumes/pvc-7d89efa4-3d60-4837-a632-f190cd3cd9ed?action=snapshotCreate]\n"})}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.strong,{children:"Solution:"})}),"\n",(0,t.jsxs)(o.p,{children:["To clean up the snapshots for all volumes, please run below script ",(0,t.jsx)(o.a,{target:"_blank",href:n(4079).Z+"",children:"longhorn-snapshot-cleanup.sh"})]}),"\n",(0,t.jsx)(o.p,{children:"While executing the script, you need to pass below argument:"}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:["-u -> longhorn backend URL. Run ",(0,t.jsx)(o.code,{children:"kubectl get svc -n longhorn-system  longhorn-backend -o json | jq -r '.spec | (.clusterIP|tostring)  + \":\" + (.ports[0].port|tostring)'"})," to fetch URL"]}),"\n",(0,t.jsx)(o.li,{children:"-d -> Number of days, snapshots older than given number of days will get deleted"}),"\n"]}),"\n",(0,t.jsx)(o.admonition,{title:"Tip:",type:"tip",children:(0,t.jsxs)(o.p,{children:["You can use below command to fetch list of the volume having toomanysnapshot error\n",(0,t.jsx)(o.code,{children:'kubectl get volumes -n longhorn-system  -o json  | jq -r \'.items[] | select(([ .status.conditions[] | select(.type == "toomanysnapshots" and .status == "True") ] | length ) == 1 ) | .metadata.name\''})]})}),"\n",(0,t.jsx)(o.h3,{id:"how-to-automate-snapshot-cleanup",children:"How to automate snapshot cleanup"}),"\n",(0,t.jsxs)(o.p,{children:["To make snapshot deletion automatically, please create a cronjob using below file. Run ",(0,t.jsx)(o.code,{children:"kubectl apply -f  snapshot-cleanup.yaml"})," to create cronjob. You can change schedule parameter accordingly."]}),"\n",(0,t.jsxs)(o.p,{children:["The script can be found here ",(0,t.jsx)(o.a,{target:"_blank",href:n(1086).Z+"",children:"longhorn-snapshot-cleanup.yaml"})]})]})}function u(e={}){const{wrapper:o}={...(0,s.a)(),...e.components};return o?(0,t.jsx)(o,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}},4079:(e,o,n)=>{n.d(o,{Z:()=>t});const t=n.p+"assets/files/longhorn-snapshot-cleanup-9ac1dda1b4ecfb9a7acd1c6e95b7d7e7.sh"},1086:(e,o,n)=>{n.d(o,{Z:()=>t});const t=n.p+"assets/files/longhorn-snapshot-cleanup-8f106a216feb8a7d1bf65660f98e3311.yaml"},1151:(e,o,n)=>{n.d(o,{Z:()=>l,a:()=>r});var t=n(7294);const s={},a=t.createContext(s);function r(e){const o=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(o):{...o,...e}}),[o,e])}function l(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(a.Provider,{value:o},e.children)}}}]);